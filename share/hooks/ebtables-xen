#!/usr/bin/env ruby

VM_NAME=ARGV[0]

def activate(rule)
    system "sudo ebtables -A #{rule}"
end

vm_id=`sudo xm domid one-#{VM_NAME}`.strip
networks=`sudo xm network-list #{vm_id}`.split("\n")[1..-1]

networks.each {|net|
    n=net.split
    iface_id=n[0]
    iface_mac=n[2]

    mac=iface_mac.split(':')
    mac[-1]='00'
    net_mac=mac.join(':')

    tap="vif#{vm_id}.#{iface_id}"

    in_rule="FORWARD -s ! #{net_mac}/ff:ff:ff:ff:ff:00 -o #{tap} -j DROP"
    out_rule="FORWARD -s ! #{iface_mac} -i #{tap} -j DROP"

    activate(in_rule)
    activate(out_rule)
}

