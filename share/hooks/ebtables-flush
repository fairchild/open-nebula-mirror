#!/usr/bin/env ruby

def deactivate(rule)
    system "sudo ebtables -D #{rule}"
end

def get_interfaces
    brctl_exit=`brctl show`
    brctl_exit.split("\n")[1..-1].collect{|l| l.split.last }
end

RULE_TYPES=[
    /-i ([\w\.\-]+) /,
    /-o ([\w\.\-]+) /
]

def get_rules
    rules=Array.new
    RULE_TYPES.each do |reg|
        ebtables_exit=`sudo ebtables -L FORWARD`
        rules << ebtables_exit.split("\n")[3..-1].collect do |l|
            line=l.strip
            m=line.match(reg)
            if m
                interface=m[1]
                {
                    :interface  => interface, 
                    :rule       => line
                }
            else
                nil
            end
        end.compact
    end
    rules.flatten
end

interfaces=get_interfaces
all_rules=get_rules

all_rules.each do |rule|
    if !interfaces.include?(rule[:interface])
        deactivate("FORWARD #{rule[:rule]}") 
    end
end

